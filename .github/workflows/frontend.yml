name: üöÄ Deploy Safeplug Frontend to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Security: Limit permissions to minimum required
permissions:
  contents: read

jobs:
  deploy:
    name: üß© Build & Deploy Next.js SSR
    runs-on: ubuntu-latest
    # Security: Set timeout to prevent hanging workflows
    timeout-minutes: 15
    
    # Security: Define environment for deployment
    environment:
      name: production
      url: https://safeplug.com

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚ö° Setup Node.js and npm caching
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: üîê Set up SSH with Host Key Verification
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîë Add VPS Host Key (Security:Prevent MITM attacks)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_HOST_KEY }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: üß† Test SSH connection
        run: |
          echo "üîó Testing SSH connection..."
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo ‚úÖ SSH connection successful!"

      - name: üìù Create .env file for build
        run: |
          echo "üìù Creating .env file from GitHub Secrets..."
          # Security: Write directly to file without echoing to logs
          printenv ENV_FILE_CONTENT > .env
          echo "‚úÖ .env file created"
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE }}

      - name: üèóÔ∏è Build Next.js app (SSR)
        run: |
          echo "üèóÔ∏è Installing dependencies..."
          npm ci --ignore-scripts=false --audit=false
          echo "‚öôÔ∏è Building Next.js app..."
          npm run build
          echo "‚úÖ Build completed successfully!"

      - name: üì¶ Upload project to VPS
        run: |
          echo "üì¶ Uploading project files to VPS via rsync..."
          rsync -az --delete \
            -e "ssh -o BatchMode=yes" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='/node_modules' \
            --exclude='.next/cache' \
            --exclude='.env.local' \
            --exclude='.env.development' \
            ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/safeplug/safeplugfrontend/

      - name: üìù Securely create .env file on VPS
        run: |
          # Security: Use heredoc with proper quoting to prevent injection
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'cat > /root/safeplug/safeplugfrontend/.env && chmod 600 /root/safeplug/safeplugfrontend/.env' << 'ENVEOF'
          ${{ secrets.ENV_FILE }}
          ENVEOF
          echo "‚úÖ .env file created on VPS with secure permissions"

      - name: üöÄ Deploy & Restart PM2 Service
        run: |
          echo "üöÄ Deploying on VPS..."
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd /root/safeplug/safeplugfrontend

            echo "üì¶ Preparing standalone build..."
            
            echo "üìÇ Copying public folder to standalone..."
            cp -r /root/safeplug/safeplugfrontend/public /root/safeplug/safeplugfrontend/.next/standalone/ || true
            
            echo "üìÇ Copying static folder to standalone..."
            cp -r /root/safeplug/safeplugfrontend/.next/static /root/safeplug/safeplugfrontend/.next/standalone/.next/ || true
            
            echo "üìù Copying .env to standalone with secure permissions..."
            cp /root/safeplug/safeplugfrontend/.env /root/safeplug/safeplugfrontend/.next/standalone/ || true
            chmod 600 /root/safeplug/safeplugfrontend/.next/standalone/.env || true

            echo "üßπ Cleaning old PM2 process..."
            pm2 stop safeplug-frontend || true
            pm2 delete safeplug-frontend || true

            echo "‚öôÔ∏è Starting Next.js standalone server on port 3001..."
            cd /root/safeplug/safeplugfrontend/.next/standalone
            PORT=3001 pm2 start server.js --name "safeplug-frontend" --update-env

            echo "üíæ Saving PM2 state..."
            pm2 save

            echo "‚úÖ Deployment completed successfully!"
          EOF

      - name: ‚úÖ Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          ssh -o BatchMode=yes ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "üìä PM2 Status:"
            pm2 list | grep safeplug || echo "‚ö†Ô∏è safeplug-frontend not running"
            echo ""
            echo "üîç Health check:"
            curl -sf http://localhost:3001 > /dev/null && echo "‚úÖ Frontend responding" || echo "‚ö†Ô∏è Frontend not responding"
          EOF
